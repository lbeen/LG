<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.report.cockpit.mapper.CockpitMapper">
    <select id="lifetimeGt150" parameterType="Map" resultType="Record">
        SELECT
            SUBSTR(GET_SHIFT_DAY(S.CREATION_TIME),6) K,
            ROUND(SUM(CASE
                WHEN S.LIFETIME_B_F>=150 THEN S.QUALIFIED_LENGTH_F
                WHEN S.LIFETIME_B_F&lt;150 AND S.LIFETIME_A_F>150 THEN
                      S.QUALIFIED_LENGTH_F-(150-S.LIFETIME_B_F)/(S.LIFETIME_A_F-S.LIFETIME_B_F )*S.QUALIFIED_LENGTH_F
                ELSE 0 END)/SUM(S.QUALIFIED_LENGTH_F)*100,1) V
        FROM AT_PM_SILICONRODSDETAIL S JOIN AT_QM_RESALONG R
            ON R.SPEC_S=S.SPEC_S AND R.ISPRODUCTION_S='是' AND S.SPEC_S NOT IN ('100H0','890H0')
        WHERE S.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
        GROUP BY GET_SHIFT_DAY(S.CREATION_TIME)
    </select>
    <select id="orderInfo" resultType="Record">
        SELECT
            O.ORDER_NUMBER_S,O.SPEC_S,R.ISPRODUCTION_S,GET_SHOP_BYCN(O.ORDER_NUMBER_S) WORKSHOP
        FROM AT_PM_ORDER O JOIN AT_QM_RESALONG R ON R.SPEC_S=O.SPEC_S
        WHERE O.ORDER_NUMBER_S IN
        <foreach collection="orders" item="order" open="(" close=")" separator=",">
            #{order}
        </foreach>
    </select>
    <select id="yesterdayRunPullerGroupSpec" resultType="Record">
        SELECT
            T.SPEC_S K,COUNT(1) V
        FROM
            (SELECT
                 ROW_NUMBER() OVER(PARTITION BY P.FURNACE_NUMBER ORDER BY O.SPEC_S) RN,
                     O.ORDER_NUMBER_S,O.SPEC_S
             FROM T_MES_RUN_PULLER P
                      JOIN AT_PM_ORDER O ON O.ORDER_NUMBER_S=SUBSTR(P.ORDER_NUMBER,1,10)
             WHERE P.DATE_S=TO_CHAR(SYSDATE-1,'YYYY-MM-DD')) T
                JOIN AT_QM_RESALONG R ON R.SPEC_S=T.SPEC_S AND R.ISPRODUCTION_S='是'
        WHERE T.SPEC_S NOT LIKE '%H0' AND T.SPEC_S NOT LIKE '%C0'
        GROUP BY T.SPEC_S
    </select>
    <select id="yesterdayRunPullersGroupWorkshop" resultType="Record">
        SELECT
            T.WORKSHOP K,COUNT(1) V
        FROM
            (SELECT
                 ROW_NUMBER() OVER(PARTITION BY P.FURNACE_NUMBER ORDER BY P.WORKSHOP) RN,
                     O.SPEC_S,P.WORKSHOP
             FROM T_MES_RUN_PULLER P
                      JOIN AT_PM_ORDER O ON O.ORDER_NUMBER_S=SUBSTR(P.ORDER_NUMBER,1,10)
             WHERE P.DATE_S=TO_CHAR(SYSDATE-1,'YYYY-MM-DD')) T
                JOIN AT_QM_RESALONG R ON R.SPEC_S=T.SPEC_S AND R.ISPRODUCTION_S='是'
        WHERE T.SPEC_S NOT LIKE '%H0' AND T.SPEC_S NOT LIKE '%C0'
        GROUP BY T.WORKSHOP
    </select>
    <select id="runPullerGroupSpec" resultType="Record">
        SELECT
          TEN.SPEC_S K,COUNT(1) V
        FROM AT_PM_ORDER O
          JOIN AT_PM_ORDER TEN ON TEN.ORDER_NUMBER_S=SUBSTR(O.ORDER_NUMBER_S,1,10)
          JOIN AT_QM_RESALONG R ON R.SPEC_S=TEN.SPEC_S AND R.ISPRODUCTION_S='是'
        WHERE O.FURNACE_NUMBER_S IS NOT NULL AND (O.STATE_I IN (2,6) OR O.END_TIME_ACTUAL_T>TRUNC(SYSDATE)+8/24)
          AND TEN.SPEC_S NOT LIKE '%H0' AND TEN.SPEC_S NOT LIKE '%C0'
        GROUP BY TEN.SPEC_S
    </select>
    <select id="runPullersGroupWorkshop" resultType="Record">
        SELECT
          GET_SHOP_BYCN(O.ORDER_NUMBER_S) K,COUNT(1) V
        FROM AT_PM_ORDER O
          JOIN AT_PM_ORDER TEN ON TEN.ORDER_NUMBER_S=SUBSTR(O.ORDER_NUMBER_S,1,10)
          JOIN AT_QM_RESALONG R ON R.SPEC_S=TEN.SPEC_S AND R.ISPRODUCTION_S='是'
        WHERE O.FURNACE_NUMBER_S IS NOT NULL AND (O.STATE_I IN (2,6) OR O.END_TIME_ACTUAL_T>TRUNC(SYSDATE)+8/24)
          AND TEN.SPEC_S NOT LIKE '%H0' AND TEN.SPEC_S NOT LIKE '%C0'
        GROUP BY GET_SHOP_BYCN(O.ORDER_NUMBER_S)
    </select>
    <select id="finish" parameterType="Map" resultType="Record">
        SELECT
            SUBSTR(GET_SHIFT_DAY(S.CREATION_TIME),6) K,
            ROUND(SUM(NVL(S.METER_WEIGHING_F,0))/1000,2) V
        FROM AT_PM_SILICONRODSDETAIL S
                 JOIN AT_QM_RESALONG R ON R.SPEC_S=S.SPEC_S AND R.ISPRODUCTION_S='是'
        WHERE S.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
          AND SUBSTR(CRYSTAL_NUMBER_S,13,1) NOT IN ('T','U','V')
        GROUP BY GET_SHIFT_DAY(S.CREATION_TIME)
    </select>
    <select id="finishTarget" resultType="Double">
        SELECT TARGETS_F/1000 FROM
            (SELECT ROW_NUMBER() OVER(ORDER BY CREATION_TIME DESC) RN,TARGETS_F
             FROM AT_PM_WEEKPRODUCTIONTARGETS WHERE AREA_S='机加一车间')
        WHERE RN=1
    </select>
    <select id="feeding" parameterType="Map" resultType="Record">
        SELECT
            SUBSTR(GET_SHIFT_DAY(RELEASE_TIME_T),6) K,
            ROUND(SUM(NVL(QUANTITY_F,0)-NVL(MODIFY_QUANTITY_F,0)-NVL(OPERABLE_QUANTITY_F,0))/1000,2) V
        FROM AT_PM_MATERIALPREPARATION2
        WHERE RELEASE_TIME_T >= TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
        GROUP BY GET_SHIFT_DAY(RELEASE_TIME_T)
    </select>
    <select id="squareYield" parameterType="Map" resultType="Record">
        SELECT
            T.WORKSHOP K1,SUBSTR(T.SHIFT_DAY,6) K2,SUM(T.QUALIFIED_LENGTH_F/C.SQUARE_STANDARD_F) V
        FROM
            (SELECT
                GET_SHOP_BYCN(S.CRYSTAL_NUMBER_S) WORKSHOP,GET_SHIFT_DAY(F.CREATION_TIME) SHIFT_DAY,
                S.QUALIFIED_LENGTH_F,S.SPEC_S FINISH_SPEC,
                (SELECT SPEC_S FROM AT_PM_ORDER
                    WHERE ORDER_NUMBER_S=SUBSTR(S.CRYSTAL_NUMBER_S,0,10)) ORDER_SPEC,
                (SELECT SPEC_S FROM AT_PM_LINEATIONANDDETECTION
                WHERE CRYSTAL_NUMBER_S=SUBSTR(S.CRYSTAL_NUMBER_S,0,11)) MAO_SPEC
            FROM AT_PM_SILICONRODSDETAIL S
                JOIN AT_PM_LINEATIONANDDETECTION F ON F.IS_FINISH_S='F'
                AND SUBSTR(F.CRYSTAL_NUMBER_S,0,10)=SUBSTR(S.CRYSTAL_NUMBER_S,0,10)
            WHERE F.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
                AND F.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')) T
            JOIN AT_QM_RESALONG R ON R.SPEC_S=T.ORDER_SPEC AND R.ISPRODUCTION_S='是'
            JOIN AT_MM_CONVERSION C ON C.SPEC_S=T.MAO_SPEC
            LEFT JOIN AT_TM_SPECCHANGE SP ON SP.SPEC_S=T.MAO_SPEC AND SP.TRANSFORMED_PRODUCT_S=T.FINISH_SPEC
        WHERE T.ORDER_SPEC NOT LIKE '%H0' AND T.ORDER_SPEC NOT LIKE '%C0' AND SP.ATR_KEY IS NULL
        GROUP BY WORKSHOP,SHIFT_DAY
    </select>
    <select id="timeSingle" parameterType="Map" resultType="Record">
        SELECT
            GET_SHOP_BYCN(F.CRYSTAL_NUMBER_S) K1,SUBSTR(GET_SHIFT_DAY(F.CREATION_TIME),6) K2,
            SUM((TO_DATE(F.END_TIME_S,'YYYY-MM-DD HH24:MI:SS')-TO_DATE(F.START_TIME_S,'YYYY-MM-DD HH24:MI:SS'))*24-NVL(O.ABNORMAL_TIME_H_S,0)) V
        FROM AT_PM_LINEATIONANDDETECTION F
            JOIN AT_PM_ORDER O ON O.ORDER_NUMBER_S=SUBSTR(F.CRYSTAL_NUMBER_S,0,10)
            JOIN AT_QM_RESALONG R ON R.SPEC_S=O.SPEC_S
        WHERE F.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
            AND F.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')
            AND F.IS_FINISH_S='F' AND F.START_TIME_S IS NOT NULL AND F.END_TIME_S IS NOT NULL
            AND O.SPEC_S NOT LIKE '%H0' AND O.SPEC_S NOT LIKE '%C0' AND R.ISPRODUCTION_S='是'
        GROUP BY GET_SHOP_BYCN(F.CRYSTAL_NUMBER_S),GET_SHIFT_DAY(F.CREATION_TIME)
    </select>
    <select id="squareYieldBySpec" parameterType="Map" resultType="Record">
        SELECT
            T.ORDER_SPEC K1,SUBSTR(T.SHIFT_DAY,6) K2,SUM(T.QUALIFIED_LENGTH_F/C.SQUARE_STANDARD_F) V
        FROM
        (SELECT
            GET_SHOP_BYCN(S.CRYSTAL_NUMBER_S) WORKSHOP,GET_SHIFT_DAY(F.CREATION_TIME) SHIFT_DAY,
            S.QUALIFIED_LENGTH_F,S.SPEC_S FINISH_SPEC,
            (SELECT SPEC_S FROM AT_PM_ORDER
                WHERE ORDER_NUMBER_S=SUBSTR(S.CRYSTAL_NUMBER_S,0,10)) ORDER_SPEC,
            (SELECT SPEC_S FROM AT_PM_LINEATIONANDDETECTION
                WHERE CRYSTAL_NUMBER_S=SUBSTR(S.CRYSTAL_NUMBER_S,0,11)) MAO_SPEC
        FROM AT_PM_SILICONRODSDETAIL S
            JOIN AT_PM_LINEATIONANDDETECTION F ON F.IS_FINISH_S='F'
            AND SUBSTR(F.CRYSTAL_NUMBER_S,0,10)=SUBSTR(S.CRYSTAL_NUMBER_S,0,10)
        WHERE F.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
            AND F.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')) T
        JOIN AT_QM_RESALONG R ON R.SPEC_S=T.ORDER_SPEC AND R.ISPRODUCTION_S='是'
        JOIN AT_MM_CONVERSION C ON C.SPEC_S=T.MAO_SPEC
        LEFT JOIN AT_TM_SPECCHANGE SP ON SP.SPEC_S=T.MAO_SPEC AND SP.TRANSFORMED_PRODUCT_S=T.FINISH_SPEC
        WHERE T.ORDER_SPEC NOT LIKE '%H0' AND T.ORDER_SPEC NOT LIKE '%C0' AND SP.ATR_KEY IS NULL
        GROUP BY ORDER_SPEC,SHIFT_DAY
    </select>
    <select id="timeSingleBySpec" parameterType="Map" resultType="Record">
        SELECT
            O.SPEC_S K1,SUBSTR(GET_SHIFT_DAY(F.CREATION_TIME),6) K2,
            SUM((TO_DATE(F.END_TIME_S,'YYYY-MM-DD HH24:MI:SS')-TO_DATE(F.START_TIME_S,'YYYY-MM-DD HH24:MI:SS'))*24-NVL(O.ABNORMAL_TIME_H_S,0)) V
        FROM AT_PM_LINEATIONANDDETECTION F
                 JOIN AT_PM_ORDER O ON O.ORDER_NUMBER_S=SUBSTR(F.CRYSTAL_NUMBER_S,0,10)
                 JOIN AT_QM_RESALONG R ON R.SPEC_S=O.SPEC_S
        WHERE F.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
          AND F.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')
          AND F.IS_FINISH_S='F' AND F.START_TIME_S IS NOT NULL AND F.END_TIME_S IS NOT NULL
          AND O.SPEC_S NOT LIKE '%H0' AND O.SPEC_S NOT LIKE '%C0' AND R.ISPRODUCTION_S='是'
        GROUP BY O.SPEC_S,GET_SHIFT_DAY(F.CREATION_TIME)
    </select>
    <select id="avgFinishRate" parameterType="Map" resultType="Double">
        SELECT
            SUM(YIELD)/SUM(WWC) FINISH_RATE
        FROM
            (SELECT
                (SELECT SUM(NVL(DISLOCATION_FREE_LENGTH_F,0) + NVL(LOW_RESISTANCE_LENGTH_F,0))
                FROM AT_PM_LINEATIONANDDETECTION WHERE ORDER_NUMBER_S LIKE T.ORDER_NUMBER||'%') WWC,
                SUM(T.QUALIFIED_LENGTH_F) YIELD
            FROM
                (SELECT
                    SUBSTR(S.CRYSTAL_NUMBER_S,0,10) ORDER_NUMBER,S.QUALIFIED_LENGTH_F,S.SPEC_S FINISH_SPEC,
                    (SELECT SPEC_S FROM AT_PM_ORDER
                        WHERE ORDER_NUMBER_S=SUBSTR(S.CRYSTAL_NUMBER_S,0,10)) ORDER_SPEC,
                    (SELECT SPEC_S FROM AT_PM_LINEATIONANDDETECTION
                        WHERE CRYSTAL_NUMBER_S=SUBSTR(S.CRYSTAL_NUMBER_S,0,11)) MAO_SPEC
                FROM AT_PM_SILICONRODSDETAIL S
                    JOIN AT_PM_LINEATIONANDDETECTION F ON F.IS_FINISH_S='F'
                    AND SUBSTR(F.CRYSTAL_NUMBER_S,0,10)=SUBSTR(S.CRYSTAL_NUMBER_S,0,10)
                WHERE F.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
                    AND F.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')) T
                JOIN AT_QM_RESALONG R ON R.SPEC_S=T.ORDER_SPEC AND R.ISPRODUCTION_S='是'
                LEFT JOIN AT_TM_SPECCHANGE SP ON SP.SPEC_S=T.MAO_SPEC AND SP.TRANSFORMED_PRODUCT_S=T.FINISH_SPEC
                WHERE T.ORDER_SPEC NOT LIKE '%H0' AND T.ORDER_SPEC NOT LIKE '%C0' AND SP.ATR_KEY IS NULL
            GROUP BY ORDER_NUMBER)
    </select>
    <select id="getWwcWeight" parameterType="Map" resultType="Record">
        SELECT
            ORDER_SPEC K1,SUBSTR(SHIFT_DAY,6) K2,SUM(YIELD) V
        FROM
            (SELECT
                MAX(T.ORDER_SPEC) ORDER_SPEC,GET_SHIFT_DAY(MAX(T.CREATION_TIME)) SHIFT_DAY,
                (SELECT SUM((NVL(DISLOCATION_FREE_LENGTH_F,0) + NVL(LOW_RESISTANCE_LENGTH_F,0))/C.SQUARE_STANDARD_F)
                FROM AT_PM_LINEATIONANDDETECTION L JOIN AT_MM_CONVERSION C ON C.SPEC_S=L.SPEC_S
                WHERE ORDER_NUMBER_S LIKE T.ORDER_NUMBER||'%') YIELD
            FROM
                (SELECT
                    SUBSTR(S.CRYSTAL_NUMBER_S,0,10) ORDER_NUMBER,F.CREATION_TIME,
                    S.QUALIFIED_LENGTH_F,S.SPEC_S FINISH_SPEC,
                    (SELECT SPEC_S FROM AT_PM_ORDER
                    WHERE ORDER_NUMBER_S=SUBSTR(S.CRYSTAL_NUMBER_S,0,10)) ORDER_SPEC,
                    (SELECT SPEC_S FROM AT_PM_LINEATIONANDDETECTION
                    WHERE CRYSTAL_NUMBER_S=SUBSTR(S.CRYSTAL_NUMBER_S,0,11)) MAO_SPEC
                FROM AT_PM_SILICONRODSDETAIL S
                    JOIN AT_PM_LINEATIONANDDETECTION F ON F.IS_FINISH_S='F'
                        AND SUBSTR(F.CRYSTAL_NUMBER_S,0,10)=SUBSTR(S.CRYSTAL_NUMBER_S,0,10)
                WHERE F.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
                    AND F.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')) T
                JOIN AT_QM_RESALONG R ON R.SPEC_S=T.ORDER_SPEC AND R.ISPRODUCTION_S='是'
                LEFT JOIN AT_TM_SPECCHANGE SP ON SP.SPEC_S=T.MAO_SPEC AND SP.TRANSFORMED_PRODUCT_S=T.FINISH_SPEC
                WHERE T.ORDER_SPEC NOT LIKE '%H0' AND T.ORDER_SPEC NOT LIKE '%C0' AND SP.ATR_KEY IS NULL
                GROUP BY ORDER_NUMBER)
        GROUP BY ORDER_SPEC,SHIFT_DAY
    </select>

    <select id="squareYieldBySpec2" parameterType="Map" resultType="Record">
        SELECT
            T.ORDER_SPEC K1,SUBSTR(T.SHIFT_DAY,6) K2,SUM(T.QUALIFIED_LENGTH_F/C.SQUARE_STANDARD_F) V
        FROM
            (SELECT
                 GET_SHOP_BYCN(S.CRYSTAL_NUMBER_S) WORKSHOP,GET_SHIFT_DAY(F.CREATION_TIME) SHIFT_DAY,
                 S.QUALIFIED_LENGTH_F,S.SPEC_S FINISH_SPEC,
                 (SELECT SPEC_S FROM AT_PM_ORDER
                  WHERE ORDER_NUMBER_S=F.ORDER_NUMBER_S) ORDER_SPEC,
                 (SELECT SPEC_S FROM AT_PM_LINEATIONANDDETECTION
                  WHERE CRYSTAL_NUMBER_S=SUBSTR(S.CRYSTAL_NUMBER_S,0,11)) MAO_SPEC
             FROM AT_PM_SILICONRODSDETAIL S
                      JOIN AT_PM_LINEATIONANDDETECTION F ON F.IS_FINISH_S='F'
                 AND SUBSTR(F.CRYSTAL_NUMBER_S,0,10)=SUBSTR(S.CRYSTAL_NUMBER_S,0,10)
             WHERE F.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
               AND F.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')) T
                JOIN AT_QM_RESALONG R ON R.SPEC_S=T.ORDER_SPEC AND R.ISPRODUCTION_S='是'
                JOIN AT_MM_CONVERSION C ON C.SPEC_S=T.MAO_SPEC
                LEFT JOIN AT_TM_SPECCHANGE SP ON SP.SPEC_S=T.MAO_SPEC AND SP.TRANSFORMED_PRODUCT_S=T.FINISH_SPEC
        WHERE T.ORDER_SPEC NOT LIKE '%H0' AND T.ORDER_SPEC NOT LIKE '%C0' AND SP.ATR_KEY IS NULL
        GROUP BY ORDER_SPEC,SHIFT_DAY
    </select>
    <select id="timeSingleBySpec2" parameterType="Map" resultType="Record">
        SELECT
            O.SPEC_S K1,SUBSTR(GET_SHIFT_DAY(F.CREATION_TIME),6) K2,
            SUM((TO_DATE(F.END_TIME_S,'YYYY-MM-DD HH24:MI:SS')-TO_DATE(F.START_TIME_S,'YYYY-MM-DD
            HH24:MI:SS'))*24-NVL(O2.ABNORMAL_TIME_H_S,0)) V
        FROM AT_PM_LINEATIONANDDETECTION F
                 JOIN AT_PM_ORDER O ON O.ORDER_NUMBER_S=F.ORDER_NUMBER_S
                 JOIN AT_PM_ORDER O2 ON O2.ORDER_NUMBER_S=SUBSTR(F.CRYSTAL_NUMBER_S,0,10)
                 JOIN AT_QM_RESALONG R ON R.SPEC_S=O.SPEC_S
        WHERE F.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
          AND F.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')
          AND F.IS_FINISH_S='F' AND F.START_TIME_S IS NOT NULL AND F.END_TIME_S IS NOT NULL
          AND O.SPEC_S NOT LIKE '%H0' AND O.SPEC_S NOT LIKE '%C0' AND R.ISPRODUCTION_S='是'
        GROUP BY O.SPEC_S,GET_SHIFT_DAY(F.CREATION_TIME)
    </select>
    <select id="avgFinishRate2" parameterType="Map" resultType="Double">
        SELECT
            SUM(YIELD)/SUM(WWC) FINISH_RATE
        FROM
            (SELECT
                 (SELECT SUM(NVL(DISLOCATION_FREE_LENGTH_F,0) + NVL(LOW_RESISTANCE_LENGTH_F,0))
                  FROM AT_PM_LINEATIONANDDETECTION WHERE ORDER_NUMBER_S LIKE T.ORDER_NUMBER||'%') WWC,
                 SUM(T.QUALIFIED_LENGTH_F) YIELD
             FROM
                 (SELECT
                      SUBSTR(S.CRYSTAL_NUMBER_S,0,10) ORDER_NUMBER,S.QUALIFIED_LENGTH_F,S.SPEC_S FINISH_SPEC,
                      (SELECT SPEC_S FROM AT_PM_ORDER
                       WHERE ORDER_NUMBER_S=F.ORDER_NUMBER_S) ORDER_SPEC,
                      (SELECT SPEC_S FROM AT_PM_LINEATIONANDDETECTION
                       WHERE CRYSTAL_NUMBER_S=SUBSTR(S.CRYSTAL_NUMBER_S,0,11)) MAO_SPEC
                  FROM AT_PM_SILICONRODSDETAIL S
                           JOIN AT_PM_LINEATIONANDDETECTION F ON F.IS_FINISH_S='F'
                      AND SUBSTR(F.CRYSTAL_NUMBER_S,0,10)=SUBSTR(S.CRYSTAL_NUMBER_S,0,10)
                  WHERE F.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
                    AND F.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')) T
                     JOIN AT_QM_RESALONG R ON R.SPEC_S=T.ORDER_SPEC AND R.ISPRODUCTION_S='是'
                     LEFT JOIN AT_TM_SPECCHANGE SP ON SP.SPEC_S=T.MAO_SPEC AND SP.TRANSFORMED_PRODUCT_S=T.FINISH_SPEC
             WHERE T.ORDER_SPEC NOT LIKE '%H0' AND T.ORDER_SPEC NOT LIKE '%C0' AND SP.ATR_KEY IS NULL
             GROUP BY ORDER_NUMBER)
    </select>
    <select id="getWwcWeight2" parameterType="Map" resultType="Record">
        SELECT
            ORDER_SPEC K1,SUBSTR(SHIFT_DAY,6) K2,SUM(YIELD) V
        FROM
            (SELECT
                 MAX(T.ORDER_SPEC) ORDER_SPEC,GET_SHIFT_DAY(MAX(T.CREATION_TIME)) SHIFT_DAY,
                 (SELECT SUM((NVL(DISLOCATION_FREE_LENGTH_F,0) + NVL(LOW_RESISTANCE_LENGTH_F,0))/C.SQUARE_STANDARD_F)
                  FROM AT_PM_LINEATIONANDDETECTION L JOIN AT_MM_CONVERSION C ON C.SPEC_S=L.SPEC_S
                  WHERE ORDER_NUMBER_S LIKE T.ORDER_NUMBER||'%') YIELD
             FROM
                 (SELECT
                      SUBSTR(S.CRYSTAL_NUMBER_S,0,10) ORDER_NUMBER,F.CREATION_TIME,
                      S.QUALIFIED_LENGTH_F,S.SPEC_S FINISH_SPEC,
                      (SELECT SPEC_S FROM AT_PM_ORDER
                       WHERE ORDER_NUMBER_S=F.ORDER_NUMBER_S) ORDER_SPEC,
                      (SELECT SPEC_S FROM AT_PM_LINEATIONANDDETECTION
                       WHERE CRYSTAL_NUMBER_S=SUBSTR(S.CRYSTAL_NUMBER_S,0,11)) MAO_SPEC
                  FROM AT_PM_SILICONRODSDETAIL S
                           JOIN AT_PM_LINEATIONANDDETECTION F ON F.IS_FINISH_S='F'
                      AND SUBSTR(F.CRYSTAL_NUMBER_S,0,10)=SUBSTR(S.CRYSTAL_NUMBER_S,0,10)
                  WHERE F.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
                    AND F.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')) T
                     JOIN AT_QM_RESALONG R ON R.SPEC_S=T.ORDER_SPEC AND R.ISPRODUCTION_S='是'
                     LEFT JOIN AT_TM_SPECCHANGE SP ON SP.SPEC_S=T.MAO_SPEC AND SP.TRANSFORMED_PRODUCT_S=T.FINISH_SPEC
             WHERE T.ORDER_SPEC NOT LIKE '%H0' AND T.ORDER_SPEC NOT LIKE '%C0' AND SP.ATR_KEY IS NULL
             GROUP BY ORDER_NUMBER)
        GROUP BY ORDER_SPEC,SHIFT_DAY
    </select>
    <select id="squareYieldTarget" parameterType="Map" resultType="Record">
        SELECT TO_CHAR(TIME_T,'YYYY-MM-DD') K,TARGETS_F V FROM AT_PM_WEEKPRODUCTIONTARGETS
        WHERE AREA_S='一车间方棒单产'
        AND TIME_T>=(SELECT MAX(TIME_T) FROM AT_PM_WEEKPRODUCTIONTARGETS
            WHERE AREA_S='一车间方棒单产' AND TIME_T&lt;=TO_DATE(#{startTime}, 'YYYY-MM-DD'))
        ORDER BY TIME_T DESC
    </select>
    <select id="singleYield" parameterType="Map" resultType="Record">
        SELECT
            SUBSTR(GET_SHIFT_DAY(L.CREATION_TIME),6) K1,GET_SHOP_BYCN(L.CRYSTAL_NUMBER_S) K2,
            ROUND(SUM((NVL(DISLOCATION_FREE_LENGTH_F,0)+NVL(LOW_RESISTANCE_LENGTH_F,0))/M.ROUND_STANDARD_F)/1000,1) V
        FROM AT_PM_LINEATIONANDDETECTION L
            JOIN AT_PM_ORDER O ON O.ORDER_NUMBER_S=L.ORDER_NUMBER_S
            JOIN AT_MM_CONVERSION M ON M.SPEC_S=L.SPEC_S
        WHERE L.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
            AND L.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')
        GROUP BY GET_SHIFT_DAY(L.CREATION_TIME),GET_SHOP_BYCN(L.CRYSTAL_NUMBER_S)
    </select>
    <select id="machineYield" parameterType="Map" resultType="Record">
        SELECT
            SUBSTR(GET_SHIFT_DAY(S.CREATION_TIME),6) K1,GET_MECHINE_SHOPNAME(S.AREA_S) K2,
            ROUND(SUM(S.METER_WEIGHING_F)/1000,1) V
        FROM AT_PM_SILICONRODSDETAIL S
            JOIN AT_QM_RESALONG R ON R.SPEC_S=S.SPEC_S AND R.ISPRODUCTION_S='是'
        WHERE S.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
            AND S.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')
        GROUP BY GET_SHIFT_DAY(S.CREATION_TIME),S.AREA_S
    </select>
    <select id="machineYieldTC" parameterType="Map" resultType="Record">
        SELECT
            SUBSTR(GET_SHIFT_DAY(S.CREATION_TIME),6) K1,GET_SHOP_BYCN(S.CRYSTAL_NUMBER_S) K2,
            ROUND(SUM(S.METER_WEIGHING_F)/1000,1) V
        FROM AT_PM_SILICONRODSDETAIL S
             JOIN AT_QM_RESALONG R ON R.SPEC_S=S.SPEC_S AND R.ISPRODUCTION_S='是'
        WHERE S.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
          AND S.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')
        GROUP BY GET_SHIFT_DAY(S.CREATION_TIME),GET_SHOP_BYCN(S.CRYSTAL_NUMBER_S)
    </select>
    <select id="turnoverDays" parameterType="Map" resultType="Record">
        WITH MAX_CLOSE AS
            (SELECT TRUNC(MAX(STARTTIME_T))+8/24 START_TIME FROM AT_PM_CLOSINGTIME WHERE STARTTIME_T&lt;=SYSDATE)
        SELECT
            O.CRYSTAL_TYPE K1,SUBSTR(O.SHIFT_DAY,6) K2,ROUND(O.WEIGHT/S.WEIGHT,2) V
        FROM
            (SELECT
                (CASE WHEN CRYSTAL_TYPE LIKE '%毛棒%' THEN '毛棒' ELSE '其他' END) CRYSTAL_TYPE,
                GET_SHIFT_DAY(CREAT_TIME) SHIFT_DAY,SUM(WEIGHT) WEIGHT
            FROM "MachingOnline" WHERE CREAT_TIME>=(SELECT START_TIME FROM MAX_CLOSE)
                AND SPEC NOT IN ('100H0','890H0')
                AND SPEC IN (SELECT SPEC_S FROM AT_QM_RESALONG WHERE ISPRODUCTION_S = '是')
            GROUP BY (CASE WHEN CRYSTAL_TYPE LIKE '%毛棒%' THEN '毛棒' ELSE '其他' END),GET_SHIFT_DAY(CREAT_TIME)) O
            JOIN
            (SELECT
                GET_SHIFT_DAY(CREATION_TIME+1) SHIFT_DAY,SUM(METER_WEIGHING_F) AS WEIGHT
            FROM AT_PM_SILICONRODSDETAIL WHERE CREATION_TIME>=(SELECT START_TIME FROM MAX_CLOSE)
                AND CREATION_TIME>=TRUNC(SYSDATE-7)+8/24 AND CREATION_TIME&lt;=TRUNC(SYSDATE)+8/24
                AND SPEC_S NOT IN ('100H0','890H0')
                AND SPEC_S IN (SELECT SPEC_S FROM AT_QM_RESALONG WHERE ISPRODUCTION_S = '是')
            GROUP BY GET_SHIFT_DAY(CREATION_TIME+1)) S
            ON S.SHIFT_DAY=O.SHIFT_DAY
    </select>
    <select id="machineOnline48" resultType="Record">
        SELECT
            O.CRY_TYPE K1,SUBSTR(O.AREA,3) K2,
            ROUND(SUM(O.LENGTH/C.SQUARE_STANDARD_F)/1000,1) V
        FROM JJONLINE O JOIN AT_MM_CONVERSION C ON C.SPEC_S = O.SPEC
        WHERE O.CREATION_TIME >= SYSDATE-4
          AND O.SPEC IN (SELECT SPEC_S FROM AT_QM_RESALONG WHERE ISPRODUCTION_S='是')
          AND (O.CREATION_TIME-O.RECIVE_TIME )>'0002 00:00:00'
          AND TO_CHAR(O.CREATION_TIME,'YYYY-MM-DD HH24')=(SELECT TO_CHAR(MAX(CREATION_TIME),'YYYY-MM-DD HH24') FROM JJONLINE)
        GROUP BY O.AREA,O.CRY_TYPE
    </select>
    <select id="singleOnline8" resultType="Record">
        SELECT
            GET_SHOP_BYCN(C.CRYSTAL_NUMBER_S) K,ROUND(SUM(M.SUM_WEIGHT_F) / 1000, 1) V
        FROM AT_PM_CRYSTALRODSORDER C JOIN AT_PM_MAOBARRECORD M ON M.CRYSTAL_NUMBER_S=C.CRYSTAL_NUMBER_S
        WHERE M.CREATION_TIME>SYSDATE-60 AND M.RECEIVE_TIME_T IS NULL AND (SYSDATE-m.CREATION_TIME)>'0000 08:00:00'
        GROUP BY GET_SHOP_BYCN(C.CRYSTAL_NUMBER_S)
    </select>
    <select id="singleFinishedRate" parameterType="Map" resultType="Record">
        SELECT
            SUBSTR(SHIFT_DAY,6) K,ROUND(SUM(CPZL)/SUM(ZTLL)*100, 2) V
        FROM
            (SELECT
                 GET_SHIFT_DAY(MAX(T.CREATION_TIME)) SHIFT_DAY,
                 SUM((WWC-NVL(HS,0)) / C.ROUND_STANDARD_F) CPZL,
                 (SELECT
                      SUM(NVL(QUANTITY_F,0) - NVL(OPERABLE_QUANTITY_F,0) - NVL(MODIFY_QUANTITY_F,0))
                  FROM AT_PM_MATERIALPREPARATION2
                  WHERE ORDER_NUMBER_S LIKE T.ORDER_NUMBER ||'%' AND PART_NUMBER_S NOT LIKE '250%') ZTLL
             FROM
                 (SELECT
                      SUBSTR(F.CRYSTAL_NUMBER_S,1,10) ORDER_NUMBER,F.CREATION_TIME,L.SPEC_S,
                      NVL(L.DISLOCATION_FREE_LENGTH_F,0)+NVL(L.LOW_RESISTANCE_LENGTH_F,0) WWC,
                      (SELECT SUM(NVL(PAY_LENGTH_F,0)) FROM AT_PM_PAY_LENGTH
                       WHERE CRYSTAL_NUMBER_S=L.CRYSTAL_NUMBER_S AND PARTMENT_S IS NULL) HS
                  FROM AT_PM_LINEATIONANDDETECTION L JOIN AT_PM_LINEATIONANDDETECTION F
                    ON SUBSTR(F.CRYSTAL_NUMBER_S,1,10)=SUBSTR(L.CRYSTAL_NUMBER_S,1,10) AND F.IS_FINISH_S='F'
                  WHERE F.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
                    AND F.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')) T
                     JOIN AT_MM_CONVERSION C ON C.SPEC_S=T.SPEC_S
             GROUP BY ORDER_NUMBER)
        GROUP BY SHIFT_DAY
    </select>
    <select id="payLength"  parameterType="Map" resultType="Record">
        SELECT
            P.PARTMENT K1,SUBSTR(P.SHIFT_DAY,6) K2,ROUND(P.PAY_LENGTH/W.WWC*100,2) V
        FROM
            (SELECT
                 PARTMENT, SHIFT_DAY, SUM(NVL(PAY_LENGTH_F, 0)) PAY_LENGTH
            FROM
                (SELECT
                     GET_SHIFT_DAY(CREATION_TIME) SHIFT_DAY,NVL(PARTMENT_S, '单晶') PARTMENT,PAY_LENGTH_F
                FROM AT_PM_PAY_LENGTH
                WHERE CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
                AND CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS'))
            GROUP BY SHIFT_DAY, PARTMENT) P
            JOIN
            (SELECT
                SHIFT_DAY,SUM(NVL(DISLOCATION_FREE_LENGTH_F,0)+NVL(LOW_RESISTANCE_LENGTH_F,0)) WWC
            FROM
                (SELECT
                     GET_SHIFT_DAY(CREATION_TIME) SHIFT_DAY,DISLOCATION_FREE_LENGTH_F,0,LOW_RESISTANCE_LENGTH_F,0
                FROM AT_PM_LINEATIONANDDETECTION
                WHERE CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
                AND CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS'))
                GROUP BY SHIFT_DAY) W
            ON W.SHIFT_DAY=P.SHIFT_DAY
    </select>
    <select id="singleOnline" resultType="Record">
        SELECT
            ONLINE_TYPE K1,AREA K2,ROUND(SUM(NVL(SUM_WEIGHT_F,0))/1000,1) V
        FROM
            (SELECT
                 SUBSTR(C.CRYSTAL_NUMBER_S,6,1) AREA,M.SUM_WEIGHT_F,
                 (CASE WHEN SYSDATE-CAST(M.CREATION_TIME AS DATE)>8/24 THEN '超8小时' ELSE '小于8小时' END) ONLINE_TYPE
             FROM AT_PM_CRYSTALRODSORDER C JOIN AT_PM_MAOBARRECORD M ON M.CRYSTAL_NUMBER_S=C.CRYSTAL_NUMBER_S
             WHERE M.CREATION_TIME>SYSDATE-60 AND M.RECEIVE_TIME_T IS NULL)
        GROUP BY AREA,ONLINE_TYPE
    </select>
    <select id="machineOnline" resultType="Record">
        SELECT
            CRYSTAL_TYPE K,ROUND(SUM(WEIGHT)/1000,1) V
        FROM
            (SELECT
                 (CASE
                      WHEN TYPE_I=2 THEN '成品方棒'
                      WHEN TYPE_I=1 THEN '毛方棒'
                      WHEN EXISTS (SELECT 1 FROM IF_CCS_CUTOFF_WIP
                                   WHERE CRYSTAL_NUMBER=SUBSTR(T.CRYSTAL_NUMBER_S,1,11) AND STATU='OFF') THEN '圆棒'
                      ELSE '毛棒'
                END) CRYSTAL_TYPE,
                 (CASE
                      WHEN TYPE_I=2 OR TYPE_I=1 THEN T.LENGTH_F/C.SQUARE_STANDARD_F
                      ELSE T.LENGTH_F/C.ROUND_STANDARD_F
                     END) WEIGHT
             FROM
                 (SELECT
                      ROW_NUMBER() OVER(PARTITION BY M.CRYSTAL_NUMBER_S ORDER BY M.TYPE_I DESC) RN,
                          M.CRYSTAL_NUMBER_S,M.SPEC_S,M.TYPE_I,M.ORDER_STATE_I,M.LENGTH_F
                  FROM AT_PM_MACHINEACCOMPANYORDER M
                           JOIN AT_PM_LINEATIONANDDETECTION L ON L.CRYSTAL_NUMBER_S=M.BLANK_BAR_NUMBER_S
                  WHERE M.CREATION_TIME>=SYSDATE-60
                    AND NOT EXISTS (SELECT 1 FROM AT_PM_SILICONRODSDETAIL WHERE CRYSTAL_NUMBER_S=M.CRYSTAL_NUMBER_S)
                    AND NOT EXISTS (SELECT 1 FROM AT_QM_UNQUALIFIEDREVIEW WHERE CRYSTAL_NUMBER_S=M.CRYSTAL_NUMBER_S
                                        AND CUTBROKENKNIFETYPE_I IN (1,2,5,6,7,8,9))
                    AND LENGTH(M.CRYSTAL_NUMBER_S)=13 ) T
                     JOIN AT_MM_CONVERSION C ON C.SPEC_S=T.SPEC_S
             WHERE RN=1 AND (ORDER_STATE_I IS NULL OR ORDER_STATE_I!=3)  AND TYPE_I!=6
                AND NOT EXISTS (SELECT 1 FROM AT_PM_WORKBLANKLINEATION WHERE CRYSTAL_NUMBER_S=T.CRYSTAL_NUMBER_S
                                    AND TRIAL_PROCESSING_I in (7) )
                AND NOT EXISTS (SELECT 1 FROM AT_PM_ONLINETIMEOUT WHERE CRYSTAL_NUMBER_S=T.CRYSTAL_NUMBER_S))
        GROUP BY CRYSTAL_TYPE
        UNION ALL
        SELECT
            '毛棒检测' K,ROUND(SUM(M.SUM_WEIGHT_F)/1000,1) V
        FROM AT_PM_MAOBARRECORD M  LEFT JOIN AT_PM_LINEATIONANDDETECTION L ON L.CRYSTAL_NUMBER_S=M.CRYSTAL_NUMBER_S
        WHERE M.CREATION_TIME>SYSDATE-60 AND M.RECEIVE_TIME_T IS NOT NULL  AND L.ATR_KEY IS NULL
    </select>
</mapper>
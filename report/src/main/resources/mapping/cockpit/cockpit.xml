<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Cockpit">
    <select id="finish" parameterType="Map" resultType="Record">
        SELECT
            GET_SHIFT_DAY(CREATION_TIME) X,
            ROUND(SUM(NVL(METER_WEIGHING_F,0)),0) Y
        FROM AT_PM_SILICONRODSDETAIL
        WHERE CREATION_TIME >= TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
          AND SUBSTR(CRYSTAL_NUMBER_S,13,1) NOT IN ('T','U','V')
        GROUP BY GET_SHIFT_DAY(CREATION_TIME)
        ORDER BY GET_SHIFT_DAY(CREATION_TIME) DESC
    </select>
    <select id="feeding" parameterType="Map" resultType="Record">
        SELECT
            GET_SHIFT_DAY(RELEASE_TIME_T) X,
            ROUND(SUM(NVL(QUANTITY_F,0)-NVL(MODIFY_QUANTITY_F,0)-NVL(OPERABLE_QUANTITY_F,0)),0) Y
        FROM AT_PM_MATERIALPREPARATION2
        WHERE RELEASE_TIME_T >= TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
        GROUP BY GET_SHIFT_DAY(RELEASE_TIME_T)
        ORDER BY GET_SHIFT_DAY(RELEASE_TIME_T) DESC
    </select>
    <select id="squareSingleYield" resultType="Record">
        WITH ORDERS AS
            (SELECT
                DISTINCT GET_SHIFT_DAY(S.CREATION_TIME) SHIFT_DAY,S.AREA_S,
                SUBSTR(S.CRYSTAL_NUMBER_S,0,10) ORDER_NUMBER,S.SPEC_S,ISPRODUCTION_S
            FROM AT_PM_SILICONRODSDETAIL S JOIN AT_PM_LINEATIONANDDETECTION F
                    ON F.CRYSTAL_NUMBER_S=SUBSTR(S.CRYSTAL_NUMBER_S,1,11) AND F.IS_FINISH_S='F'
                LEFT JOIN AT_QM_RESALONG R ON R.SPEC_S=S.SPEC_S
            WHERE S.CREATION_TIME>=TRUNC(SYSDATE)+8/24-7
            AND S.CREATION_TIME&lt;TRUNC(SYSDATE)+8/24)
        SELECT
            SUBSTR(CL.SHIFT_DAY,6) X,
            DECODE(CL.AREA_S,'CJ01_JJ','一车间','CJ02_JJ','二车间','CJ03_JJ','三车间') LEGEND,
            ROUND(CL.WEIGHT/LJYS.LJYS,1) AS Y
        FROM
            (SELECT
                T1.SHIFT_DAY,T1.AREA_S,SUM(S.METER_WEIGHING_F) WEIGHT
            FROM
                (SELECT
                    DISTINCT SHIFT_DAY,AREA_S,ORDER_NUMBER
                FROM ORDERS WHERE ORDERS.ISPRODUCTION_S='是' AND ORDERS.SPEC_S NOT IN ('100H0','890H0')) T1
                    JOIN AT_PM_SILICONRODSDETAIL S ON SUBSTR(S.CRYSTAL_NUMBER_S,0,10)=T1.ORDER_NUMBER
                GROUP BY T1.SHIFT_DAY,T1.AREA_S) CL
                LEFT JOIN
                (SELECT
                    T1.SHIFT_DAY,T1.AREA_S,
                    SUM((TO_DATE( L.END_TIME_S, 'YYYY-MM-DD HH24:MI:SS')-TO_DATE( L.START_TIME_S,'YYYY-MM-DD HH24:MI:SS'))* 24-NVL(O.ABNORMAL_TIME_H_S,0)) LJYS
                FROM
                    (SELECT DISTINCT SHIFT_DAY,AREA_S,ORDER_NUMBER FROM ORDERS) T1
                    JOIN AT_PM_LINEATIONANDDETECTION L
                        ON SUBSTR(L.CRYSTAL_NUMBER_S,0,10)=T1.ORDER_NUMBER AND L.IS_FINISH_S='F'
                    JOIN AT_PM_ORDER O ON O.ORDER_NUMBER_S=T1.ORDER_NUMBER
                GROUP BY T1.SHIFT_DAY,T1.AREA_S) LJYS
                ON LJYS.SHIFT_DAY=CL.SHIFT_DAY AND LJYS.AREA_S=CL.AREA_S
    </select>
    <select id="turnoverDays" resultType="Record">
        WITH MAX_CLOSE AS
            (SELECT TRUNC(MAX(STARTTIME_T))+8/24 START_TIME FROM AT_PM_CLOSINGTIME WHERE STARTTIME_T&lt;=SYSDATE)
        SELECT
            SUBSTR(T1.SHIFT_DAY,6) X,T1.CRYSTAL_TYPE LEGEND,ROUND(T1.WEIGHT/T2.WEIGHT,2) Y
        FROM
            (SELECT
                GET_SHIFT_DAY(CREAT_TIME) SHIFT_DAY,SUM(WEIGHT/1000) WEIGHT,
                (CASE WHEN CRYSTAL_TYPE LIKE '%毛棒%' THEN '毛棒' ELSE '其他' END) CRYSTAL_TYPE
            FROM "MachingOnline"
            WHERE CREAT_TIME>=(SELECT START_TIME FROM MAX_CLOSE) AND SPEC NOT IN ('100H0','890H0')
                AND SPEC IN (SELECT SPEC_S FROM AT_QM_RESALONG WHERE ISPRODUCTION_S = '是')
            GROUP BY GET_SHIFT_DAY(CREAT_TIME),(CASE WHEN CRYSTAL_TYPE LIKE '%毛棒%' THEN '毛棒' ELSE '其他' END)) T1
            JOIN
            (SELECT
                GET_SHIFT_DAY(CREATION_TIME+1) SHIFT_DAY,SUM(METER_WEIGHING_F/1000) WEIGHT
            FROM AT_PM_SILICONRODSDETAIL
            WHERE CREATION_TIME>=(SELECT START_TIME FROM MAX_CLOSE)
                AND CREATION_TIME>=TRUNC(SYSDATE)+8/24-7 AND CREATION_TIME&lt;TRUNC(SYSDATE)+8/24
                AND SPEC_S NOT IN ('100H0','890H0')
                AND SPEC_S IN (SELECT SPEC_S FROM AT_QM_RESALONG WHERE ISPRODUCTION_S = '是')
            GROUP BY GET_SHIFT_DAY(CREATION_TIME+1)) T2
            ON T2.SHIFT_DAY=T1.SHIFT_DAY
    </select>
    <select id="lifetimeGt150" resultType="Record">
        SELECT
            SUBSTR(GET_SHIFT_DAY(CREATION_TIME),6) X,
            ROUND(SUM(CASE WHEN LIFETIME_B_F>150 THEN 1 ELSE 0 END)/COUNT(1),2)*100 Y
        FROM AT_PM_SILICONRODSDETAIL WHERE CREATION_TIME>TRUNC(SYSDATE)+8/24-6
        GROUP BY GET_SHIFT_DAY(CREATION_TIME)
    </select>
    <select id="machineOnline48" resultType="Record">
        SELECT
            SUBSTR(O.AREA,3) X,O.CRY_TYPE LEGEND,
            ROUND(SUM(O.LENGTH/C.SQUARE_STANDARD_F)/1000,1) Y
        FROM JJONLINE O JOIN AT_MM_CONVERSION C ON C.SPEC_S = O.SPEC
        WHERE O.CREATION_TIME >= SYSDATE-4 AND O.SPEC NOT IN ('100H0','890H0')
          AND O.SPEC IN (SELECT SPEC_S FROM AT_QM_RESALONG WHERE ISPRODUCTION_S='是')
          AND (O.CREATION_TIME-O.RECIVE_TIME )>'0002 00:00:00'
          AND TO_CHAR(O.CREATION_TIME,'YYYY-MM-DD HH24')=(SELECT TO_CHAR(MAX(CREATION_TIME),'YYYY-MM-DD HH24') FROM JJONLINE)
        GROUP BY O.AREA,O.CRY_TYPE
    </select>
    <select id="singleOnline8" resultType="Record">
        SELECT
            GET_SHOP_BYCN(C.CRYSTAL_NUMBER_S) X,ROUND(SUM(LENGTH_F) / 1000, 1) Y
        FROM AT_PM_CRYSTALRODSORDER C
            JOIN AT_PM_MAOBARRECORD M ON M.CRYSTAL_NUMBER_S=C.CRYSTAL_NUMBER_S
        WHERE M.CREATION_TIME>TO_DATE('2021-04-01','YYYY-MM-DD') AND M.CREATION_TIME&lt;SYSDATE-8/24
            AND M.RECEIVE_TIME_T IS NULL AND M.LENGTH_F IS NOT NULL
        GROUP BY GET_SHOP_BYCN(C.CRYSTAL_NUMBER_S)
    </select>
    <select id="breakLine" resultType="Record">
        SELECT
            T1.WORKSHOP,ROUND(T1.DD/T2.PULLERS,3) 断线,ROUND(T1.FD/T2.PULLERS,3) 放断,ROUND(T1.QSD/T2.PULLERS,3) 切手动
        FROM
            (SELECT
                GETWORKSHOP(ZONE) WORKSHOP,
                SUM(CASE WHEN STEPNO=8 THEN 1 ELSE 0 END) DD,
                SUM(CASE WHEN STEPNO=7 OR (STEPNO=6 AND (ENDTIME-STARTTIME)*24>0.5) THEN 1 ELSE 0 END) FD,
                SUM(CASE WHEN STEPNO IN (4,5) OR (STEPNO=6 AND (ENDTIME-STARTTIME)*24&lt;=0.5) THEN 1 ELSE 0 END) QSD
            FROM BS_DATA_ALL
            WHERE ENDTIME >= TO_DATE(#{startTime},'YYYY-MM-DD HH24:MI:SS')
              AND ENDTIME &lt; TO_DATE(#{endTime},'YYYY-MM-DD HH24:MI:SS') AND ISSUCCESSFUL=0
            GROUP BY GETWORKSHOP(ZONE)) T1
            JOIN
            (SELECT
                SUBSTR(AREA,3) WORKSHOP,SUM(CON) PULLERS
            FROM RUN_PULLER@BS_SCADA_TO_PROD
            WHERE DATETIME = TO_CHAR(TRUNC(SYSDATE)+8/24-1,'YYYY-MM-DD')
            GROUP BY AREA) T2
            ON T2.WORKSHOP=T1.WORKSHOP
    </select>
    <select id="buttYield" resultType="Record">
        SELECT
            DECODE(T.MACSHOP,'CJ01_JJ','一车间','CJ02_JJ','二车间','CJ03_JJ','三车间') X,
            ROUND(SUM(T.LENGTH_BUTT/C.SQUARE_STANDARD_F),1) Y
        FROM
        (SELECT
            I.MACSHOP,I.CREATE_TIME,M.SPEC_S,I.LENGTH_BUTT,
            ROW_NUMBER() OVER(PARTITION BY I.CRYSTAL_NUMBER ORDER BY CREATE_TIME DESC) RN
            FROM IF_CCS_BUTT_WIP I JOIN AT_PM_MACHINEACCOMPANYORDER M
            ON M.CRYSTAL_NUMBER_S=I.CRYSTAL_NUMBER AND M.TYPE_I=1
            WHERE I.CREATE_TIME>SYSDATE-7 AND I.STATU='OFF' AND I.REMARK1 IS NULL) T
        JOIN AT_MM_CONVERSION C ON C.SPEC_S=T.SPEC_S
        WHERE T.RN=1 AND T.CREATE_TIME >= TRUNC(SYSDATE)+8/24-1 AND T.CREATE_TIME &lt; TRUNC(SYSDATE)+8/24
        GROUP BY T.MACSHOP
    </select>
    <select id="polishingYield" resultType="Record">
        SELECT
            DECODE(T.MACSHOP,'CJ01_JJ','一车间','CJ02_JJ','二车间','CJ03_JJ','三车间') X,
            ROUND(SUM(T.POLISHING_LENGTH/C.SQUARE_STANDARD_F),1) Y
        FROM
            (SELECT
                 I.MACSHOP,I.CREATE_TIME,M.SPEC_S,I.POLISHING_LENGTH,
                 ROW_NUMBER() OVER(PARTITION BY I.CRYSTAL_NUMBER ORDER BY CREATE_TIME DESC) RN
             FROM IF_CCS_POLISHING_WIP I JOIN AT_PM_MACHINEACCOMPANYORDER M
                                         ON M.CRYSTAL_NUMBER_S=I.CRYSTAL_NUMBER AND M.TYPE_I=2
             WHERE I.CREATE_TIME>SYSDATE-7 AND I.STATU='OFF' AND I.REMARK1 IS NULL) T
                JOIN AT_MM_CONVERSION C ON C.SPEC_S=T.SPEC_S
        WHERE T.RN=1 AND T.CREATE_TIME >= TRUNC(SYSDATE)+8/24-1 AND T.CREATE_TIME &lt; TRUNC(SYSDATE)+8/24
        GROUP BY T.MACSHOP
    </select>
</mapper>
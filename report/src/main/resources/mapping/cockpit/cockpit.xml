<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Cockpit">
    <select id="lifetimeGt150" resultType="Record">
        SELECT
            SUBSTR(GET_SHIFT_DAY(S.CREATION_TIME),6) K,
            ROUND(SUM(CASE
                WHEN S.LIFETIME_B_F>=150 THEN S.QUALIFIED_LENGTH_F
                WHEN S.LIFETIME_B_F&lt;150 AND S.LIFETIME_A_F>150 THEN
                      S.QUALIFIED_LENGTH_F-(150-S.LIFETIME_B_F)/(S.LIFETIME_A_F-S.LIFETIME_B_F )*S.QUALIFIED_LENGTH_F
                ELSE 0 END)/SUM(S.QUALIFIED_LENGTH_F)*100,1) V
        FROM AT_PM_SILICONRODSDETAIL S JOIN AT_QM_RESALONG R
            ON R.SPEC_S=S.SPEC_S AND R.ISPRODUCTION_S='是' AND S.SPEC_S NOT IN ('100H0','890H0')
        WHERE S.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
        GROUP BY GET_SHIFT_DAY(S.CREATION_TIME)
    </select>
    <select id="breakLine" resultType="Record">
        SELECT
            T1.WORKSHOP,
            ROUND(T1.DD/T2.PULLERS*100,1) DD,
            ROUND(T1.FD/T2.PULLERS*100,1) FD,
            ROUND(T1.QSD/T2.PULLERS*100,1) QSD
        FROM
            (SELECT
                 GETWORKSHOP(ZONE) WORKSHOP,
                 SUM(CASE WHEN STEPNO=8 THEN 1 ELSE 0 END) DD,
                 SUM(CASE WHEN STEPNO=7 OR (STEPNO=6 AND (ENDTIME-STARTTIME)*24>0.5) THEN 1 ELSE 0 END) FD,
                 SUM(CASE WHEN STEPNO IN (4,5) OR (STEPNO=6 AND (ENDTIME-STARTTIME)*24&lt;=0.5) THEN 1 ELSE 0 END) QSD
             FROM BS_DATA_ALL
             WHERE ENDTIME >= TO_DATE(#{startTime},'YYYY-MM-DD HH24:MI:SS')
               AND ENDTIME &lt; TO_DATE(#{endTime},'YYYY-MM-DD HH24:MI:SS') AND ISSUCCESSFUL=0
             GROUP BY GETWORKSHOP(ZONE)) T1
                JOIN
            (SELECT
                 SUBSTR(AREA,3) WORKSHOP,SUM(CON) PULLERS
             FROM RUN_PULLER@BS_SCADA_TO_PROD
             WHERE DATETIME = #{startDay}
             GROUP BY AREA) T2
            ON T2.WORKSHOP=T1.WORKSHOP
    </select>
    <select id="finish" parameterType="Map" resultType="Record">
        SELECT
            SUBSTR(GET_SHIFT_DAY(S.CREATION_TIME),6) K,
            ROUND(SUM(NVL(S.METER_WEIGHING_F,0))/1000,2) V
        FROM AT_PM_SILICONRODSDETAIL S
                 JOIN AT_QM_RESALONG R ON R.SPEC_S=S.SPEC_S AND R.ISPRODUCTION_S='是'
        WHERE S.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
          AND SUBSTR(CRYSTAL_NUMBER_S,13,1) NOT IN ('T','U','V')
        GROUP BY GET_SHIFT_DAY(S.CREATION_TIME)
    </select>
    <select id="feeding" parameterType="Map" resultType="Record">
        SELECT
            SUBSTR(GET_SHIFT_DAY(RELEASE_TIME_T),6) K,
            ROUND(SUM(NVL(QUANTITY_F,0)-NVL(MODIFY_QUANTITY_F,0)-NVL(OPERABLE_QUANTITY_F,0))/1000,2) V
        FROM AT_PM_MATERIALPREPARATION2
        WHERE RELEASE_TIME_T >= TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
        GROUP BY GET_SHIFT_DAY(RELEASE_TIME_T)
    </select>
    <!--执行计划不稳定，用子查询判断是否量产品和取计重系数-->
    <select id="squareYield" parameterType="Map" resultType="Record">
        SELECT
            SUBSTR(SPARE_1_S,3) K1,SUBSTR(SHIFT_DAY,6) K2,
            SUM((NVL(DISLOCATION_FREE_LENGTH_F,0)+NVL(LOW_RESISTANCE_LENGTH_F,0)-NVL(DJJL,0))/SQUARE_STANDARD_F) V
        FROM
            (SELECT
                 F.SPARE_1_S,GET_SHIFT_DAY(F.CREATION_TIME) SHIFT_DAY,
                L.DISLOCATION_FREE_LENGTH_F,L.LOW_RESISTANCE_LENGTH_F,
                (SELECT SQUARE_STANDARD_F FROM AT_MM_CONVERSION WHERE SPEC_S=L.SPEC_S) SQUARE_STANDARD_F,
                (SELECT ISPRODUCTION_S FROM AT_QM_RESALONG WHERE SPEC_S=L.SPEC_S) ISPRODUCTION_S,
                (SELECT SUM(NVL(PAY_LENGTH_F,0)) FROM AT_PM_PAY_LENGTH
                WHERE CRYSTAL_NUMBER_S=L.CRYSTAL_NUMBER_S AND PARTMENT_S IS NULL) DJJL
            FROM AT_PM_LINEATIONANDDETECTION L JOIN AT_PM_LINEATIONANDDETECTION F
                ON L.ORDER_NUMBER_S LIKE SUBSTR(F.ORDER_NUMBER_S,1,10)||'%' AND F.IS_FINISH_S='F'
            WHERE F.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
                AND F.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')
                AND L.SPEC_S NOT IN ('100H0','890H0'))
        WHERE ISPRODUCTION_S='是' GROUP BY SPARE_1_S,SHIFT_DAY
    </select>
    <!--执行计划不稳定，用子查询判断是否量产品-->
    <select id="timeSingle" parameterType="Map" resultType="Record">
        SELECT
            SUBSTR(WORKSHOP,3) K1,SUBSTR(SHIFT_DAY,6) K2,SUM((END_TIME-START_TIME)*24-ABNORMAL_TIME_H) V
        FROM
            (SELECT
                MAX(SPARE_1_S) WORKSHOP,GET_SHIFT_DAY(MAX(CREATION_TIME)) SHIFT_DAY,
                TO_DATE(MAX(START_TIME_S),'YYYY-MM-DD HH24:MI:SS') START_TIME,
                TO_DATE(MAX(END_TIME_S),'YYYY-MM-DD HH24:MI:SS') END_TIME,
                (SELECT NVL(ABNORMAL_TIME_H_S,0) FROM AT_PM_ORDER WHERE ORDER_NUMBER_S=T.ORDER_NUMBER) ABNORMAL_TIME_H
            FROM
                (SELECT
                    SUBSTR(F.ORDER_NUMBER_S,1,10) ORDER_NUMBER,F.SPARE_1_S,F.CREATION_TIME,F.END_TIME_S,F.START_TIME_S,
                    (SELECT ISPRODUCTION_S FROM AT_QM_RESALONG WHERE SPEC_S=L.SPEC_S) ISPRODUCTION_S
                FROM AT_PM_LINEATIONANDDETECTION L JOIN AT_PM_LINEATIONANDDETECTION F
                    ON L.ORDER_NUMBER_S LIKE SUBSTR(F.ORDER_NUMBER_S,1,10)||'%' AND F.IS_FINISH_S='F'
                WHERE F.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
                    AND F.CREATION_TIME&lt;TO_DATE(#{endTime}, 'YYYY-MM-DD HH24:MI:SS')
                    AND F.START_TIME_S IS NOT NULL AND F.END_TIME_S IS NOT NULL
                    AND L.SPEC_S NOT IN ('100H0','890H0')) T
            WHERE ISPRODUCTION_S='是' GROUP BY ORDER_NUMBER)
        GROUP BY WORKSHOP,SHIFT_DAY
    </select>
    <select id="singleYield" parameterType="Map" resultType="Record">
        SELECT
            SUBSTR(GET_SHIFT_DAY(L.CREATION_TIME),6) K1,GET_SHOP_BYCN(L.CRYSTAL_NUMBER_S) K2,
            ROUND(SUM((NVL(DISLOCATION_FREE_LENGTH_F,0)+NVL(LOW_RESISTANCE_LENGTH_F,0))/M.ROUND_STANDARD_F)/1000,1) V
        FROM AT_PM_LINEATIONANDDETECTION L
            JOIN AT_PM_ORDER O ON O.ORDER_NUMBER_S=L.ORDER_NUMBER_S
            JOIN AT_MM_CONVERSION M ON M.SPEC_S=L.SPEC_S
        WHERE L.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
        GROUP BY GET_SHIFT_DAY(L.CREATION_TIME),GET_SHOP_BYCN(L.CRYSTAL_NUMBER_S)
    </select>
    <select id="machineYield" parameterType="Map" resultType="Record">
        SELECT
            SUBSTR(GET_SHIFT_DAY(S.CREATION_TIME),6) K1,GET_MECHINE_SHOPNAME(S.AREA_S) K2,
            ROUND(SUM(S.METER_WEIGHING_F)/1000,1) V
        FROM AT_PM_SILICONRODSDETAIL S
            JOIN AT_QM_RESALONG R ON R.SPEC_S=S.SPEC_S AND R.ISPRODUCTION_S='是'
        WHERE S.CREATION_TIME>=TO_DATE(#{startTime}, 'YYYY-MM-DD HH24:MI:SS')
        GROUP BY GET_SHIFT_DAY(S.CREATION_TIME),S.AREA_S
    </select>
    <select id="turnoverDays" parameterType="Map" resultType="Record">
        WITH MAX_CLOSE AS
            (SELECT TRUNC(MAX(STARTTIME_T))+8/24 START_TIME FROM AT_PM_CLOSINGTIME WHERE STARTTIME_T&lt;=SYSDATE)
        SELECT
            O.CRYSTAL_TYPE K1,SUBSTR(O.SHIFT_DAY,6) K2,ROUND(O.WEIGHT/S.WEIGHT,2) V
        FROM
            (SELECT
                (CASE WHEN CRYSTAL_TYPE LIKE '%毛棒%' THEN '毛棒' ELSE '其他' END) CRYSTAL_TYPE,
                GET_SHIFT_DAY(CREAT_TIME) SHIFT_DAY,SUM(WEIGHT) WEIGHT
            FROM "MachingOnline" WHERE CREAT_TIME>=(SELECT START_TIME FROM MAX_CLOSE)
                AND SPEC NOT IN ('100H0','890H0')
                AND SPEC IN (SELECT SPEC_S FROM AT_QM_RESALONG WHERE ISPRODUCTION_S = '是')
            GROUP BY (CASE WHEN CRYSTAL_TYPE LIKE '%毛棒%' THEN '毛棒' ELSE '其他' END),GET_SHIFT_DAY(CREAT_TIME)) O
            JOIN
            (SELECT
                GET_SHIFT_DAY(CREATION_TIME+1) SHIFT_DAY,SUM(METER_WEIGHING_F) AS WEIGHT
            FROM AT_PM_SILICONRODSDETAIL WHERE CREATION_TIME>=(SELECT START_TIME FROM MAX_CLOSE)
                AND CREATION_TIME>=TRUNC(SYSDATE-7)+8/24 AND CREATION_TIME&lt;=TRUNC(SYSDATE)+8/24
                AND SPEC_S NOT IN ('100H0','890H0')
                AND SPEC_S IN (SELECT SPEC_S FROM AT_QM_RESALONG WHERE ISPRODUCTION_S = '是')
            GROUP BY GET_SHIFT_DAY(CREATION_TIME+1)) S
            ON S.SHIFT_DAY=O.SHIFT_DAY
    </select>
    <select id="machineOnline48" resultType="Record">
        SELECT
            O.CRY_TYPE K1,SUBSTR(O.AREA,3) K2,
            ROUND(SUM(O.LENGTH/C.SQUARE_STANDARD_F)/1000,1) V
        FROM JJONLINE O JOIN AT_MM_CONVERSION C ON C.SPEC_S = O.SPEC
        WHERE O.CREATION_TIME >= SYSDATE-4
          AND O.SPEC IN (SELECT SPEC_S FROM AT_QM_RESALONG WHERE ISPRODUCTION_S='是')
          AND (O.CREATION_TIME-O.RECIVE_TIME )>'0002 00:00:00'
          AND TO_CHAR(O.CREATION_TIME,'YYYY-MM-DD HH24')=(SELECT TO_CHAR(MAX(CREATION_TIME),'YYYY-MM-DD HH24') FROM JJONLINE)
        GROUP BY O.AREA,O.CRY_TYPE
    </select>
    <select id="singleOnline8" resultType="Record">
        SELECT
            GET_SHOP_BYCN(C.CRYSTAL_NUMBER_S) K,ROUND(SUM(M.SUM_WEIGHT_F) / 1000, 1) V
        FROM AT_PM_CRYSTALRODSORDER C JOIN AT_PM_MAOBARRECORD M ON M.CRYSTAL_NUMBER_S=C.CRYSTAL_NUMBER_S
        WHERE M.CREATION_TIME>SYSDATE-50 AND M.RECEIVE_TIME_T IS NULL
        GROUP BY GET_SHOP_BYCN(C.CRYSTAL_NUMBER_S)
    </select>
</mapper>